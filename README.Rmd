---
title: "Cuaderno de Laboratorio: Análisis de los cambios a la ley 19.886 y su eventual impacto sobre proveedores locales"
output: github_document
always_allow_html: true
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', out.width = '100%')
```


## Motivación

En el contexto de la reforma a la ley N° 19.886 en la que se introducen cambios relevantes en materia de promoción de la participación de empresas de menor tamaño en las compras públicas es que se establece, en el artículo 47, que además de ampliar el umbral para el uso de la Compra Ágil de 10 UTM a 30 UTM será exclusivo para proveedores locales, definidos estos como aquellas Pymes cuya dirección de la casa matriz coincide con la dirección de despacho

```{r, include=FALSE}
#Quita archivos del WorkSpace ===========================================================
#
rm(list = ls())

#Fija el directorio de trabajo ==========================================================
#

wd_path = "C:/o/OneDrive - DCCP/Escritorio/Proyectos/Preferencias EMT y Compras Regionales/emt_pl_dccp/datos"


setwd(wd_path)

#Carga de paquetes necesarios para el análisis ==========================================
#
load_pkg <- function(pack){
  create.pkg <- pack[!(pack %in% installed.packages()[, "Package"])]
  if (length(create.pkg))
    install.packages(create.pkg, dependencies = TRUE)
  sapply(pack, require, character.only = TRUE)
}

packages = c("tidyverse" #Conjunto integral de paquetes para manipular y analizar datos de manera coherente y eficiente.
             , "RODBC" #facilita la conexión y manipulación de bases de datos a través de ODBC (Open Database Connectivity).
             , "plotly" #proporciona herramientas interactivas para la creación de gráficos dinámicos y visualizaciones interactivas
             , "data.table" #Paquete optimizado para manipulación eficiente de grandes conjuntos de datos, destacando por su velocidad y funcionalidades avanzadas.
             , "formattable"
             , "hutils"
             , "readr"
             , "VennDiagram"
             , "RColorBrewer")

load_pkg(packages)


# #Establece conexiones a los diferentes servidores =======================================
# 
# #con = RODBC::odbcConnect("aquiles", uid = "datawarehouse", pwd = "datawarehouse") #TIVIT

con2 = RODBC::odbcConnect("aq", uid = "datawarehouse", pwd = "datawarehouse") #Aquiles

con3 = RODBC::odbcConnect("dw", uid = "datawarehouse", pwd = "datawarehouse") #Datawarehouse



detalles = function(path = wd_path, pattern = "*.rds"){
  require(dplyr)
  
  details = file.info(path = paste0(wd_path), list.files(pattern=pattern))
  
  details = details[with(details, order(as.POSIXct(mtime), decreasing = TRUE)), ] %>% 
    filter(isdir==FALSE)
  
  details$files = rownames(details)
  
  rownames(details) = NULL
  
  return(details)
}

```

La consulta para obtener los datos es la siguiente: 

```{r, eval=FALSE}

datos <- sqlQuery(con2, 
    "WITH TABLA AS (SELECT 
	  SC.Descripcion
	  ,CP.CodigoProducto
	  ,GS.productoname
	  ,CP.Descripcion [Descripcion 2]
	  ,GS.level1
	  ,GS.level2
	  ,GS.level3
	  ,CP.Cantidad
	  ,CP.Precio
	  ,CP.MontoTotalProducto
	  ,SC.CodigoRegion [Región de Despacho]
	  ,O1.orgLegalName [Razón Social Proveedor]
	  ,CO.EsProveedorSeleccionado
	  ,O1.orgActivity [Actividad Proveedor]
	  ,O2.orgLegalName [Razón Social Comprador]
--	  ,O2.orgActivity [Actividad Comprador]
	  ,(CASE  
            WHEN SII.TRAMOS_13 = 1 THEN 'Sin Ventas'
            WHEN SII.TRAMOS_13 IN (2,3,4,5,6,7,8,9) THEN 'MiPyme'
            ELSE 'Grande' END
            ) [Size]
	  ,(CASE SII.[DESCRIPCION_REGION] 
		WHEN 'I REGION DE TARAPACA' THEN 1
		WHEN 'II REGION DE ANTOFAGASTA' THEN 2
		WHEN 'III REGION DE ATACAMA' THEN 3
		WHEN 'IV REGION COQUIMBO' THEN 4
		WHEN 'V REGION VALPARAISO' THEN 5
		WHEN 'VII REGION DEL MAULE' THEN 7
		WHEN 'VIII REGION DEL BIO BIO' THEN 8
		WHEN 'IX REGION DE LA ARAUCANIA' THEN 9
		WHEN 'X REGION LOS LAGOS' THEN 10
		WHEN 'XI REGION AYSEN DEL GENERAL CARLOS IBAÑEZ DEL CAMPO' THEN 11
		WHEN 'XII REGION DE MAGALLANES Y LA ANTARTICA CHILENA' THEN 12
		WHEN 'XIII REGION METROPOLITANA' THEN 13
		WHEN 'XIV REGION DE LOS RIOS' THEN 14
		WHEN 'XV REGION ARICA Y PARINACOTA' THEN 15
		WHEN 'XVI REGION DE ÑUBLE' THEN 16
		WHEN 'Sin Información' THEN 0
		ELSE 6 END) AS id_regionProv
  FROM [DCCPCotizacion].[dbo].[SolicitudCotizacion] as SC --TABLESAMPLE (1000 ROWS) REPEATABLE (123)
  LEFT JOIN  [DCCPCotizacion].[dbo].[Cotizacion] as co ON co.SolicitudCotizacionId=SC.id and CO.ESTADOID = 2
  INNER JOIN [DCCPCotizacion].[dbo].[CotizacionProducto] as CP ON CO.Id = CP.CotizacionId
  INNER JOIN [DCCPProcurement].[dbo].[prcGoodAndService] as GS ON CP.CodigoProducto = GS.ProductoCode 
  INNER JOIN [DCCPPlatform].[dbo].[gblOrganization] as O1 ON SC.CodigoEmpresa COLLATE Modern_Spanish_CI_AI = O1.orgCode COLLATE Modern_Spanish_CI_AI
  INNER JOIN [DCCPPlatform].[dbo].[gblOrganization] as O2 ON SC.CodigoOrganismo  COLLATE Modern_Spanish_CI_AI = O2.orgCode COLLATE Modern_Spanish_CI_AI
  INNER JOIN [10.34.71.202].[Estudios].[dbo].[sii_atrib_2021] SII ON CAST(LEFT(LOWER(REPLACE(REPLACE(O1.orgTaxID,'.',''),'-',''))
        		,LEN(LOWER(REPLACE(REPLACE(O1.orgTaxID,'.',''),'-','')))-1) as VARCHAR(50))  = CAST(SII.RUT AS VARCHAR(50))
  WHERE YEAR(SC.FechaPublicacion) = 2023
  ) 
  SELECT 
    *,
    CASE 
        WHEN [id_regionProv] = [Región de Despacho] THEN 1
        ELSE 0 
    END AS [Proveedor Local 2]
FROM TABLA; 
                  ")



```

